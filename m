Return-Path: <etnaviv-bounces@lists.freedesktop.org>
X-Original-To: lists+etnaviv@lfdr.de
Delivered-To: lists+etnaviv@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 876018B930C
	for <lists+etnaviv@lfdr.de>; Thu,  2 May 2024 03:15:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7FE4110E33C;
	Thu,  2 May 2024 01:15:39 +0000 (UTC)
Authentication-Results: gabe.freedesktop.org;
	dkim=pass (2048-bit key; unprotected) header.d=collabora.com header.i=@collabora.com header.b="PMELrxB2";
	dkim-atps=neutral
X-Original-To: etnaviv@lists.freedesktop.org
Delivered-To: etnaviv@lists.freedesktop.org
Received: from madrid.collaboradmins.com (madrid.collaboradmins.com
 [46.235.227.194])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3449210E33C
 for <etnaviv@lists.freedesktop.org>; Thu,  2 May 2024 01:15:38 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=collabora.com;
 s=mail; t=1714612536;
 bh=8TfoUURsbV6/rjtTvVqB2nlBw1gjT29XbQpaTK3H3ec=;
 h=Date:To:From:Subject:From;
 b=PMELrxB2ph9M1V92FR1UfrfZrNt9PXuOz+b52sq2jAONzFQzZCP8kwvLprLhAi+0p
 cWkQrvya82va7x5I3ib8Gq+vsSRXGJEYaxbusKaKVN3JhNnEEDAzKJjI2CfJuwMdiD
 IqmYJi8N6SBSTnYNoaVg7qri7O5JJWGypj4oW28bZKbJ2xeZrGWEor5fFB0l3mdP89
 ECKmYBv5znU6WUEOmBG19pf9p+POGK1UmgqtwKjyp6j03CSIObvwPOjw75BHwY0lI3
 K+8EzXY7xB56ZBBHzSVHEx7P9vX3Wszfh+Fu33e7OZNufWdcTmkBVIuTIWxmyk0dkD
 ZtfQTYHvXQjDg==
Received: from [100.101.64.211]
 (ec2-34-240-57-77.eu-west-1.compute.amazonaws.com [34.240.57.77])
 (using TLSv1.3 with cipher TLS_AES_128_GCM_SHA256 (128/128 bits)
 key-exchange X25519 server-signature RSA-PSS (4096 bits) server-digest SHA256)
 (No client certificate requested) (Authenticated sender: simonz)
 by madrid.collaboradmins.com (Postfix) with ESMTPSA id 6773D3781013
 for <etnaviv@lists.freedesktop.org>; Thu,  2 May 2024 01:15:36 +0000 (UTC)
Message-ID: <a1d3d7aa-f812-44be-9766-5fe548235cf5@collabora.com>
Date: Wed, 1 May 2024 21:15:35 -0400
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Content-Language: en-US
To: etnaviv@lists.freedesktop.org
From: Simon Zeni <simon.zeni@collabora.com>
Subject: GPU hang & mmu fault on GC7000
Organization: Collabora
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit
X-BeenThere: etnaviv@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: <etnaviv.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/etnaviv>,
 <mailto:etnaviv-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/etnaviv>
List-Post: <mailto:etnaviv@lists.freedesktop.org>
List-Help: <mailto:etnaviv-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/etnaviv>,
 <mailto:etnaviv-request@lists.freedesktop.org?subject=subscribe>
Errors-To: etnaviv-bounces@lists.freedesktop.org
Sender: "etnaviv" <etnaviv-bounces@lists.freedesktop.org>

Hi,

I'm experiencing GPU hang with on a i.MX8 Quad Max (GC7000 rev 6009) with
linux-fslc [1] on the 6.1-2.2.x-imx branch. I've reproduced the issue on the
5.15-2.2.x-imx branch and I have not yet sorted out the 6.6.x+fslc with this
device.

Both issues are reproducible with `glmark-es2-drm` using the benchmarks
`terrain` and the `desktop:effect=shadow:windows=4`. The latter has to 
be run
with `--run-forever` to produce the hang.

 > [  774.318157] etnaviv-gpu 53100000.gpu: GPU not yet idle, mask: 
0x7fffbf76
 > [  774.830151] etnaviv-gpu 53100000.gpu: GPU not yet idle, mask: 
0x7fffbf76
 > [  775.342025] etnaviv-gpu 53100000.gpu: recover hung GPU!

The MMU fault only occurs with the `terrain` benchmark`.

 > [  775.354701] etnaviv-gpu 53100000.gpu: MMU fault status 0x00000002
 > [  775.360796] etnaviv-gpu 53100000.gpu: MMU 0 fault addr 0x00000000

I have collected devcoredumps from both benchmarks, they both share the same
idle state, dma debug state and dma address:

 > 00000004 = 7fffbf76 Idle: FE- DE+ PE+ SH- PA+ SE+ RA+ TX- VG+ IM+ FP+ TS+
 > 00000660 = 00000001 Cmd: [dec DMA: idle Fetch: idle] Req idle Cal idle
 > 00000664 = 00000905 Command DMA address

Both of them also have the line `Checking MMU entries... failed` before 
listing
the buffer offsets, is that expected?

I have searched the IRC logs (thanks for keeping this channel logged), 
and if I
get this correctly this address is an offset in the mmu.bin file 
generated by
`viv-unpack` [2]. The result in both dumps seems inconclusive.

 > 00000900  02 00 00 00 02 00 00 00  02 00 00 00 02 00 00 00 
|................|

We figured out recently that the DMA address might be corrupted, dumping it
first [3] gives a different result. Am I going in the right direction to
understand, debug and fix this (those?) issues? What more can I do, and 
where
should I look?

Thanks,

Simon

[1]: https://github.com/Freescale/linux-fslc
[2]: https://github.com/etnaviv/etna-gpu-tools/blob/master/dump/viv-unpack.c
[3]: https://lists.freedesktop.org/archives/etnaviv/2024-May/004744.html



